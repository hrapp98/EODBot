{% extends "base.html" %}

{% block title %}User Profile: {{ user.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- User Profile Card -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    {% if user.image %}
                    <img src="{{ user.image }}" alt="{{ user.name }}" class="rounded-circle img-fluid mb-3" style="max-width: 150px;">
                    {% else %}
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 150px; height: 150px; font-size: 48px;">
                        {{ user.name[0] }}
                    </div>
                    {% endif %}
                    <h3 class="card-title">{{ user.name }}</h3>
                    {% if user.title %}
                    <p class="text-muted">{{ user.title }}</p>
                    {% endif %}
                    <div class="mt-3">
                        {% if user.email %}
                        <p><i class="bi bi-envelope me-2"></i> {{ user.email }}</p>
                        {% endif %}
                        {% if user.timezone %}
                        <p><i class="bi bi-clock me-2"></i> {{ user.timezone }}</p>
                        {% endif %}
                        <p><i class="bi bi-slack me-2"></i> <span class="text-monospace">{{ user.id }}</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Submission Stats -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Submission Statistics</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stat-card text-center p-3">
                                <h2>{{ missed_submissions|length }}</h2>
                                <p class="text-muted">Missed Submissions</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-card text-center p-3">
                                <h2>{{ submission_calendar|length }}</h2>
                                <p class="text-muted">Submission Days</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submission Calendar -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Submission Calendar ({{ current_year }})</h4>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        {% set months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                        {% for month_idx in range(12) %}
                            <div class="month-container">
                                <h5 class="month-title">{{ months[month_idx] }}</h5>
                                <div class="days-grid">
                                    {% for day in range(1, 32) %}
                                        {% set date_str = '%s-%02d-%02d' % (current_year, month_idx + 1, day) %}
                                        {% if date_str in submission_calendar %}
                                            <div class="day submitted" title="Submitted on {{ date_str }}">{{ day }}</div>
                                        {% elif date_str in missed_dates and date_str >= first_submission_date and date_str <= today_date %}
                                            <div class="day missed" title="Missed on {{ date_str }}">{{ day }}</div>
                                        {% elif is_valid_date(current_year, month_idx + 1, day) %}
                                            <div class="day" title="{{ date_str }}">{{ day }}</div>
                                        {% else %}
                                            <div></div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Reports -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Recent Reports</h4>
        </div>
        <div class="card-body">
            {% if reports %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Short-term Projects</th>
                                <th>Long-term Projects</th>
                                <th>Blockers</th>
                                <th>Next Day Goals</th>
                                <th>Tools Used</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                                <tr>
                                    <td>{{ report.date }}</td>
                                    <td>{{ report.short_term_projects|truncate(30) }}</td>
                                    <td>{{ report.long_term_projects|truncate(30) }}</td>
                                    <td>{{ report.blockers|truncate(30) }}</td>
                                    <td>{{ report.next_day_goals|truncate(30) }}</td>
                                    <td>{{ report.tools_used|truncate(30) }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#reportModal{{ report.id }}">View</button>
                                    </td>
                                </tr>
                                
                                <!-- Modal for this report -->
                                <div class="modal fade" id="reportModal{{ report.id }}" tabindex="-1" aria-labelledby="reportModalLabel{{ report.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="reportModalLabel{{ report.id }}">Report for {{ report.date }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Short-term Projects</h6>
                                                    <p>{{ report.short_term_projects|nl2br }}</p>
                                                </div>
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Long-term Projects</h6>
                                                    <p>{{ report.long_term_projects|nl2br }}</p>
                                                </div>
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Blockers/Challenges</h6>
                                                    <p>{{ report.blockers|nl2br }}</p>
                                                </div>
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Next Day Goals</h6>
                                                    <p>{{ report.next_day_goals|nl2br }}</p>
                                                </div>
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Tools Used</h6>
                                                    <p>{{ report.tools_used|nl2br }}</p>
                                                </div>
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Help Needed</h6>
                                                    <p>{{ report.help_needed|nl2br }}</p>
                                                </div>
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Client Feedback</h6>
                                                    <p>{{ report.client_feedback|nl2br }}</p>
                                                </div>
                                                <div class="report-section mb-3">
                                                    <h6 class="fw-bold">Submitted At</h6>
                                                    <p>{{ report.date }} {{ report.time }}</p>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center">No reports found for this user.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Weekly Summaries -->
    {% if summaries %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Weekly Summaries</h4>
            <div class="pagination-controls">
                <a href="{{ url_for('user_profile', user_id=user.id, page=page-1) }}" 
                   class="btn btn-sm btn-outline-primary {% if not has_prev %}disabled{% endif %}">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
                <span class="mx-2">Page {{ page }} of {{ total_pages }}</span>
                <a href="{{ url_for('user_profile', user_id=user.id, page=page+1) }}" 
                   class="btn btn-sm btn-outline-primary {% if not has_next %}disabled{% endif %}">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="accordion" id="summaryAccordion">
                {% for summary in summaries %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                                Week of {{ summary.start_date }} to {{ summary.end_date }}
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#summaryAccordion">
                            <div class="accordion-body">
                                {{ summary.summary|nl2br }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% if total_pages > 1 %}
        <div class="card-footer text-center">
            <div class="btn-group">
                {% for p in range(1, total_pages + 1) %}
                    <a href="{{ url_for('user_profile', user_id=user.id, page=p) }}" 
                       class="btn btn-sm {% if p == page %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        {{ p }}
                    </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
    .calendar-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    .month-container {
        width: 150px;
    }
    .month-title {
        text-align: center;
        margin-bottom: 5px;
    }
    .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }
    .day {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
    }
    .day.submitted {
        background-color: #28a745;
        color: white;
        border-radius: 50%;
    }
    .day.missed {
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
    }
    .report-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .report-section:last-child {
        border-bottom: none;
    }
</style>
{% endblock %} 